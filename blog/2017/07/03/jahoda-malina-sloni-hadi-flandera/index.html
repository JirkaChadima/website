<!DOCTYPE html>
<html lang="cs" dir="ltr" itemtype="http://schema.org/WebPage" itemscope="">
    <head>
    
    
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Jahoda, malina, sloni, hadi, flanděra, angular | fragaria.cz</title>
    <meta name="author" content="Fragaria s.r.o." />
    <meta name="robots" content="index,follow" />
    <meta name="description" content="Přijde takhle klient do kanceláře a povídá: “Máme tady takovou velkoumašinu a k ní si můžeme koupit příšerně drahý ovládací panel. Nesvedlibyste pro nás udělat něco levnějšího?” Technicky zdatný ředitelspolečnosti nesměle dí: “To bychom asi svedli.” Klientovi se rozzáříočka a tichým hlasem dodá: “Ale potřebovali bychom, aby t...">
    <meta name="keywords" content="fragaria, software, vývoj software, webové aplikace, python, javascript, angular, elasticsearch, html, css, sqlite, javascript, python, flask, angularjs, socket.io, eventlet, postgresql, raspberry" />
    <!-- Favicons -->
    

    <meta property="og:url"           content="https://fragaria.cz/website/blog/2017/07/03/jahoda-malina-sloni-hadi-flandera/" />
    <meta property="og:type"          content="website" />
    <meta property="og:title"         content="Jahoda, malina, sloni, hadi, flanděra, angular | fragaria.cz" />
    <meta property="og:description"   content="Přijde takhle klient do kanceláře a povídá: “Máme tady takovou velkoumašinu a k ní si můžeme koupit příšerně drahý ovládací panel. Nesvedlibyste pro nás udělat něco levnějšího?” Technicky zdatný ředitelspolečnosti nesměle dí: “To bychom asi svedli.” Klientovi se rozzáříočka a tichým hlasem dodá: “Ale potřebovali bychom, aby t..." />

    

    
    <link rel="stylesheet" href="/website/assets/styles.css">
    <link rel="alternate" type="application/atom+xml" href="/website/feed.xml" title="Atom feed for this page"/>
    <link rel="self" type="application/atom+xml" href="/website/feed.xml"/>
</head>



    <body class="page-container baseline-grid ">
        <div class="page-container__inner">
            <div class="content-block js-sitenav">
    <nav class="sitenav" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
        <a href="/website/">
            <img alt="Fragaria s.r.o." class="sitenav__brand" src="/website/assets/img/strawberry.svg">
        </a>

        <ul class="sitenav__linkset">
            <li class="sitenav__linkset-item sitenav__linkset-item--main"><a href="/website/" class="sitenav__link typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Fragaria.cz</span></a></li>
            
                <li class="sitenav__linkset-item "><a href="/website/#works" class="sitenav__link typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Works</span></a></li>
            
                <li class="sitenav__linkset-item "><a href="/website/#team" class="sitenav__link typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Team</span></a></li>
            
                <li class="sitenav__linkset-item sitenav__linkset-item--active"><a href="/website/blog/" class="sitenav__link typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Blog</span></a></li>
            
                <li class="sitenav__linkset-item "><a href="/website/career/" class="sitenav__link typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Career</span></a></li>
            
        </ul>

        <div class="sitenav__menu-toggle typeset">
            <a href="#" class="sitenav__menu-toggle-link js-sitenav-menu-toggle">Menu</a>
        </div>
    </nav>
</div>


            <article itemtype="https://schema.org/TechArticle" itemscope class="article">
    <div class="content-block typeset">
        <h1 itemprop="name" class="article__headline">Jahoda, malina, sloni, hadi, flanděra, angular</h1>
        <meta itemprop="headline" content="Jahoda, malina, sloni, hadi, flanděra, angular">

        
            <meta itemprop="image" content="https://1.bp.blogspot.com/-MP986IuLAmg/WVailx1qfYI/AAAAAAAAAhg/IiqZKrZ7pOYGs5rd4IJzODHPoywnVFaZwCLcBGAs/s72-c/DBkyLKpXoAI7tsr.jpg">
        

        <div itemprop="publisher" itemtype="http://schema.org/Organization" class="hidden" itemscope>
            <div itemprop="logo" itemtype="http://schema.org/ImageObject" itemscope="">
                <meta itemprop="url" content="https://fragaria.cz/website/assets/img/strawberry.svg">
            </div>
            <meta itemprop="name" content="Fragaria s.r.o.">
        </div>

        <p class="article__meta">
            <span itemprop="author" itemtype="http://schema.org/Person" itemscope="" class="article__author">
                by <span itemprop="name">Jirka Chadima</span>
            </span>
            <meta itemprop="datePublished" content="" />
            <span class="article__pubdate">03.07.2017</span>
            <meta itemprop="publisher"></meta>
        </p>

        

        <div class="article__content-wrap">
            <div class="article__content">
                <p>Přijde takhle klient do kanceláře a povídá: “Máme tady takovou velkou
mašinu a k ní si můžeme koupit příšerně drahý ovládací panel. Nesvedli
byste pro nás udělat něco levnějšího?” Technicky zdatný ředitel
společnosti nesměle dí: “To bychom asi svedli.” Klientovi se rozzáří
očka a tichým hlasem dodá: “Ale potřebovali bychom, aby to fungovalo ve
skoro reálném čase a máme tu na to nějaká volná Raspberry Pi.”</p>

<p>Kromě výkonnosti Raspberry jsme také podle zadání docela omezeni v
technologickém rozletu: nějaký ten webový frontend, kde se budou data
ukazovat a bude je možné měnit, backend ideálně v Pythonu a jako datové
úložiště bychom rádi použili třeba SQLite. Naše vyprávění ale začneme
od uživatelského konce, tedy od
klienta.</p>

<p><a href="https://1.bp.blogspot.com/-MP986IuLAmg/WVailx1qfYI/AAAAAAAAAhg/IiqZKrZ7pOYGs5rd4IJzODHPoywnVFaZwCLcBGAs/s1600/DBkyLKpXoAI7tsr.jpg"><img src="https://1.bp.blogspot.com/-MP986IuLAmg/WVailx1qfYI/AAAAAAAAAhg/IiqZKrZ7pOYGs5rd4IJzODHPoywnVFaZwCLcBGAs/s640/DBkyLKpXoAI7tsr.jpg" alt="" /></a></p>

<h2 id="angular-websockets-a-socketio">Angular, WebSockets a socket.io</h2>

<p>Protože ve Fragarii válíme poslední dobou hlavně v Angularu, tak jsme
použili jeho čtvrtou, poslední verzi a místo tradičního pollingu se jako
komunikační protokol přímo nabízí
<a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a>. Kdo by neznal,
představí si otevřený tunel mezi prohlížečem a serverem, kudy
obousměrně tečou data. Oproti tradičnímu HTTP, zásadním způsobem
eliminujeme režii spojenou s každým novým požadavkem a tím zvyšujeme
výkon celé aplikace.</p>

<p>Jenže! Jak se později ukázalo, v Pythonu je jednodušší použít knihovnu
<a href="https://socket.io/">socket.io</a>, která umí kromě WebSocketů spousta
dalších parádních věcí - zejména se tvářit jako WebSockets i tam, kde
tahle technologie nefunguje a taky jednotlivým datovým zprávám
přiřazovat pojmenovaný typ.</p>

<p>Takže si v Angularu podobně jako v <a href="https://www.npmjs.com/package/ng2-socket-io">tomhle
návodu</a> napíšeme tupoučký
wrapper a službičku…</p>

<p>…a na dalších 20 řádkách si ten tunel ještě pustíme. No, a to je
vlastně všechno. Zbytek aplikace jsou tradiční nezajímavé formulářové
inputy, validace a taky on-screen klávesnice. Třeba trochu upravená
<a href="https://github.com/protacon/ng-virtual-keyboard">tahleta</a>.</p>

<h2 id="flask-a-socketio">Flask a socket.io</h2>

<p>Webových frameworků v Pythonu jsou samozřejmě tuny. Pojďme ale použít
něco jednoduchého, do čeho se dobře integruje socket.io. Volba padla na
<a href="http://flask.pocoo.org/">Flask</a>, pár lidí ho
<a href="https://hotframeworks.com/languages/python">používá</a> a socket.io to
<a href="https://flask-socketio.readthedocs.io/en/latest/">taky umí</a>. Přijímat
data z klienta je pak přímo odzbrojujícím způsobem jednoduché.</p>

<p>Jak se data na klienta posílají si ukážeme po krátké odbočce do světa
databází.</p>

<h2 id="sqlite-postgresql-a-listennotify">SqLite, PostgreSQL a LISTEN/NOTIFY</h2>

<p>Když už se pollingem, tedy periodickou kontrolou dat nezabýváme na ose
prohlížeč-server, byla by škoda dělat polling do databáze. Na scénu tak
vstupují SQLite a PostgreSQL, které umí pomocí
<a href="https://www.sqlite.org/c3ref/update_hook.html">update_hook</a> respektive
dvojice
<a href="https://www.postgresql.org/docs/9.4/static/sql-listen.html">LISTEN</a>/<a href="https://www.postgresql.org/docs/9.4/static/sql-notify.html">NOTIFY</a> při
nějaké události volat uživatelský kód. Pro SQLite se dá použít například
knihovna <a href="https://github.com/karellen/karellen-sqlite">karellen-sqlite</a>,
my si ukážeme, jak se problém řeší v Postgresu a
<a href="http://initd.org/psycopg/">psycopg2</a>.</p>

<p>V PostgreSQL mějme jednoduchou tabulku, z níž chceme zavolat NOTIFY
pokaždé, když do ní přibude nový řádek. Na to se samozřejme nejlépe
používají triggery.</p>

<p>Obsluha v Pythonu je pak dost jednoduchá, ale pro webový server je
blokující smyčka tak, jak je uvedená v dokumentaci, poměrně nevhodná.</p>

<h2 id="lepíme-to-celé-dohromady">Lepíme to celé dohromady</h2>

<p>Naštěstí máme
<a href="https://flask-socketio.readthedocs.io/en/latest/">flask-socketio</a> a v
něm zprovozněný <a href="http://eventlet.net/">eventlet</a>, takže se té blokující
smyčky můžeme elegantně zbavit. Použijeme na to dva background tasky (v
podstatě samostatná vlákna) v režii socket.io a asynchronní frontu s
<a href="http://eventlet.net/doc/hubs.html?highlight=trampoline#eventlet.hubs.trampoline">trampolínou</a>
z arzenálu knihovny eventlet. Celá nádhera tak vypadá následovně:</p>

<p>Neumíte si to představit? Podívejte se na následující video, kde je
navíc v provozu i REST API, aby se nemuselo sahat přímo do databáze:</p>

<h2 id="co-říci-závěrem">Co říci závěrem</h2>

<p>Díky menší zoologické zahradě existujících technologií a knihoven jsme
takhle byli schopní během pár dnů dodat firmě na balicí stroje pilotní
ukázku toho, jak by mohl vypadat reálný řídící panel s různými
komponentami. Angular nám pomohl k tomu, že řešení je modulární a z
jednotlivých komponent se dají skládat různé obrazovky. Dostatečně
obecné řešení backendu pomocí PostgreSQL a WebSockets pak umožňuje
snadnou rozšiřitelnost a přizpůsobování podle toho, jaké typy dat
potřebují jednotlivé stroje.</p>

<p>Když už frčí to reaktivní programování na frontendu, tímhle relativně
jednoduchým způsobem můžete postavit reaktivní celou aplikaci odshora
dolů. To samozřejmě šetří zdroje, možná to zlepšuje uživatelský
prožitek, ale hlavně to setsakra dobře vypadá.</p>

                <hr>
            </div>
        </div>
    </div>
    <div class="content-block">
        <div class="article__misc">
            <div class="article__miscitem">
                <div class="sharebox">
    <ul class="sharebox__items">
        <li class="sharebox__item sharebox__item--twitter">
            <a class="sharebox__item-body" href="https://twitter.com/intent/tweet?text=Jahoda, malina, sloni, hadi, flanděra, angular&url=https://fragaria.cz/blog/2017/07/03/jahoda-malina-sloni-hadi-flandera/&via=&related=" rel="nofollow" target="_blank" title="Share on Twitter"><span>Share on Twitter</span></a>
        </li>
        <li class="sharebox__item sharebox__item--facebook">
            <a class="sharebox__item-body" href="https://facebook.com/sharer.php?u=https://fragaria.cz/blog/2017/07/03/jahoda-malina-sloni-hadi-flandera/" rel="nofollow" target="_blank" title="Share on Facebook"><span>Share on Facebook</span></a>
        </li>
        <li class="sharebox__item sharebox__item--gplus">
            <a class="sharebox__item-body" href="https://plus.google.com/share?url=https://fragaria.cz/blog/2017/07/03/jahoda-malina-sloni-hadi-flandera/" rel="nofollow" target="_blank" title="Share on Google+"><span>Share on Google+</span></a>
        </li>
    </ul>
</div>

            </div>
            <div class="article__miscitem">
                <div class="taglist" itemscope itemtype="http://schema.org/WebPage">
    
        
        <a class="taglist__tag" href="/website/blog/archive/tag/sqlite/" itemprop="relatedLink">sqlite</a>
    
        
        <a class="taglist__tag" href="/website/blog/archive/tag/javascript/" itemprop="relatedLink">javascript</a>
    
        
        <a class="taglist__tag" href="/website/blog/archive/tag/python/" itemprop="relatedLink">python</a>
    
        
        <a class="taglist__tag" href="/website/blog/archive/tag/flask/" itemprop="relatedLink">flask</a>
    
        
        <a class="taglist__tag" href="/website/blog/archive/tag/angularjs/" itemprop="relatedLink">angularjs</a>
    
        
        <a class="taglist__tag" href="/website/blog/archive/tag/socket.io/" itemprop="relatedLink">socket.io</a>
    
        
        <a class="taglist__tag" href="/website/blog/archive/tag/eventlet/" itemprop="relatedLink">eventlet</a>
    
        
        <a class="taglist__tag" href="/website/blog/archive/tag/postgresql/" itemprop="relatedLink">postgresql</a>
    
        
        <a class="taglist__tag" href="/website/blog/archive/tag/raspberry/" itemprop="relatedLink">raspberry</a>
    
</div>

            </div>
        </div>
    </div>
</article>

        </div>

        <script src="/website/assets/js/site.js"></script>
    </body>
</html>
