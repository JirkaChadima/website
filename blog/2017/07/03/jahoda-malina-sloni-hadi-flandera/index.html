<!DOCTYPE html>
<html lang="cs" dir="ltr" itemtype="http://schema.org/WebPage" itemscope="">
    <head>
    
    
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Jahoda, malina, sloni, hadi, flanděra, angular | fragaria.cz</title>
    <meta name="author" content="Fragaria s.r.o." />
    <meta name="robots" content="index,follow" />
    <meta name="description" content="Přijde takhle klient do kanceláře a povídá: "Máme tady takovou velkou mašinu a k ní si můžeme koupit příšerně drahý ovládací panel. Nesvedli byste pro nás udělat něco levnějšího?" Technicky zdatný ředitel společnosti nesměle dí: "To bychom asi svedli." Klientovi se rozzáří očka a tichým hlasem dodá: "Ale potřebovali bychom, a...">
    <meta name="keywords" content="fragaria, software, vývoj software, webové aplikace, python, javascript, angular, elasticsearch, html, css, sqlitejavascriptpythonflaskangularjssocket.ioeventletpostgresqlraspberry" />
    <!-- Favicons -->
    

    <meta property="og:url"           content="https://fragaria.cz/website/blog/2017/07/03/jahoda-malina-sloni-hadi-flandera/" />
    <meta property="og:type"          content="website" />
    <meta property="og:title"         content="Jahoda, malina, sloni, hadi, flanděra, angular | fragaria.cz" />
    <meta property="og:description"   content="Přijde takhle klient do kanceláře a povídá: "Máme tady takovou velkou mašinu a k ní si můžeme koupit příšerně drahý ovládací panel. Nesvedli byste pro nás udělat něco levnějšího?" Technicky zdatný ředitel společnosti nesměle dí: "To bychom asi svedli." Klientovi se rozzáří očka a tichým hlasem dodá: "Ale potřebovali bychom, a..." />

    

    
    <link rel="stylesheet" href="/website/assets/styles.css">
</head>



    <body class="page-container">
        <div class="page-container__inner">
            <article itemtype="http://schema.org/BlogPosting" itemscope="">
  <h1 itemprop="headline">Jahoda, malina, sloni, hadi, flanděra, angular</h1>

  <div>Přijde takhle klient do kanceláře a povídá: "Máme tady takovou velkou mašinu a k ní si můžeme koupit příšerně drahý ovládací panel. Nesvedli byste pro nás udělat něco levnějšího?" Technicky zdatný ředitel společnosti nesměle dí: "To bychom asi svedli." Klientovi se rozzáří očka a tichým hlasem dodá: "Ale potřebovali bychom, aby to fungovalo ve skoro reálném čase a máme tu na to nějaká volná Raspberry Pi."<br /><a name='more'></a><br />Kromě výkonnosti Raspberry jsme také podle zadání docela omezeni v technologickém rozletu: nějaký ten webový frontend, kde se budou data ukazovat a bude je možné měnit, backend ideálně v Pythonu a jako datové úložiště bychom rádi použili třeba SQLite. Naše vyprávění ale začneme od uživatelského konce, tedy od klienta.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-MP986IuLAmg/WVailx1qfYI/AAAAAAAAAhg/IiqZKrZ7pOYGs5rd4IJzODHPoywnVFaZwCLcBGAs/s1600/DBkyLKpXoAI7tsr.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="900" data-original-width="1600" height="360" src="https://1.bp.blogspot.com/-MP986IuLAmg/WVailx1qfYI/AAAAAAAAAhg/IiqZKrZ7pOYGs5rd4IJzODHPoywnVFaZwCLcBGAs/s640/DBkyLKpXoAI7tsr.jpg" width="640" /></a></div><br /></div><div><br /><h2>Angular, WebSockets a socket.io</h2><div><br /></div>Protože ve Fragarii válíme poslední dobou hlavně v Angularu, tak jsme použili jeho čtvrtou, poslední verzi a místo tradičního pollingu se jako komunikační protokol přímo nabízí <a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a>. Kdo by neznal, představí si otevřený tunel mezi prohlížečem a serverem, kudy obousměrně tečou data. Oproti tradičnímu HTTP, zásadním způsobem eliminujeme režii spojenou s každým novým požadavkem a tím zvyšujeme výkon celé aplikace.<br /><br />Jenže! Jak se později ukázalo, v Pythonu je jednodušší použít knihovnu <a href="https://socket.io/">socket.io</a>, která umí kromě WebSocketů spousta dalších parádních věcí - zejména se tvářit jako WebSockets i tam, kde tahle technologie nefunguje a taky jednotlivým datovým zprávám přiřazovat pojmenovaný typ.<br /><br />Takže si v Angularu podobně jako v <a href="https://www.npmjs.com/package/ng2-socket-io">tomhle návodu</a> napíšeme tupoučký wrapper a službičku...<br /><script src="https://gist.github.com/JirkaChadima/c3b481c62a6da7e13518c2bf45de948b.js"></script><br />...a na dalších 20 řádkách si ten tunel ještě pustíme. No, a to je vlastně všechno. Zbytek aplikace jsou tradiční nezajímavé formulářové inputy, validace a taky on-screen klávesnice. Třeba trochu upravená <a href="https://github.com/protacon/ng-virtual-keyboard">tahleta</a>.<br /><br /><script src="https://gist.github.com/JirkaChadima/2cb6ad4dbd008c46b11253af11669892.js"></script></div><div><br /><h2>Flask a socket.io</h2><br />Webových frameworků v Pythonu jsou samozřejmě tuny. Pojďme ale použít něco jednoduchého, do čeho se dobře integruje socket.io. Volba padla na <a href="http://flask.pocoo.org/">Flask</a>, pár lidí ho <a href="https://hotframeworks.com/languages/python">používá</a>&nbsp;a socket.io to <a href="https://flask-socketio.readthedocs.io/en/latest/">taky umí</a>. Přijímat data z klienta je pak přímo odzbrojujícím způsobem jednoduché.<br /><script src="https://gist.github.com/JirkaChadima/b95cdb1ad9b31405d941d2d639149645.js"></script><br />Jak se data na klienta posílají si ukážeme po krátké odbočce do světa databází.<br /><br /><h2>SqLite, PostgreSQL a LISTEN/NOTIFY</h2><br />Když už se pollingem, tedy periodickou kontrolou dat nezabýváme na ose prohlížeč-server, byla by škoda dělat polling do databáze. Na scénu tak vstupují SQLite a PostgreSQL, které umí pomocí <a href="https://www.sqlite.org/c3ref/update_hook.html">update_hook</a> respektive dvojice <a href="https://www.postgresql.org/docs/9.4/static/sql-listen.html">LISTEN</a>/<a href="https://www.postgresql.org/docs/9.4/static/sql-notify.html">NOTIFY</a>&nbsp;při nějaké události volat uživatelský kód. Pro SQLite se dá použít například knihovna <a href="https://github.com/karellen/karellen-sqlite">karellen-sqlite</a>, my si ukážeme, jak se problém řeší v Postgresu a <a href="http://initd.org/psycopg/">psycopg2</a>.<br /><br />V PostgreSQL mějme jednoduchou tabulku, z níž chceme zavolat NOTIFY pokaždé, když do ní přibude nový řádek. Na to se samozřejme nejlépe používají triggery.<br /><script src="https://gist.github.com/JirkaChadima/99c1ced142e2910798948dd848957715.js"></script><br />Obsluha v Pythonu je pak dost jednoduchá, ale pro webový server je blokující smyčka tak, jak je uvedená v dokumentaci, poměrně nevhodná.<br /><br /><script src="https://gist.github.com/JirkaChadima/bec6ca1fc7ca3a98f3d12907cddaf4d5.js"></script></div><div><br /><h2>Lepíme to celé dohromady</h2><br />Naštěstí máme <a href="https://flask-socketio.readthedocs.io/en/latest/">flask-socketio</a> a v něm zprovozněný <a href="http://eventlet.net/">eventlet</a>, takže se té blokující smyčky můžeme elegantně zbavit. Použijeme na to dva background tasky (v podstatě samostatná vlákna) v režii socket.io a asynchronní frontu s <a href="http://eventlet.net/doc/hubs.html?highlight=trampoline#eventlet.hubs.trampoline">trampolínou</a> z arzenálu knihovny eventlet. Celá nádhera tak vypadá následovně:<br /><br /><script src="https://gist.github.com/JirkaChadima/ef2ef42c00489e2db42b7eac4535063d.js"></script><br />Neumíte si to představit? Podívejte se na následující video, kde je navíc v provozu i REST API, aby se nemuselo sahat přímo do databáze:<br /><br /><div style="text-align: center;"><iframe allowfullscreen="" frameborder="0" height="315" src="https://www.youtube.com/embed/y8cdWyMp_KE" width="560"></iframe><br /><br /><h2 style="text-align: left;">Co říci závěrem</h2><div style="text-align: left;"></div><div style="text-align: left;">Díky menší zoologické zahradě existujících technologií a knihoven jsme takhle byli schopní během pár dnů dodat firmě na balicí stroje pilotní ukázku toho, jak by mohl vypadat reálný řídící panel s různými komponentami. Angular nám pomohl k tomu, že řešení je modulární a z jednotlivých komponent se dají skládat různé obrazovky. Dostatečně obecné řešení backendu pomocí PostgreSQL a WebSockets pak umožňuje snadnou rozšiřitelnost a přizpůsobování podle toho, jaké typy dat potřebují jednotlivé stroje.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Když už frčí to reaktivní programování na frontendu, tímhle relativně jednoduchým způsobem můžete postavit reaktivní celou aplikaci odshora dolů. To samozřejmě šetří zdroje, možná to zlepšuje uživatelský prožitek, ale hlavně to setsakra dobře vypadá.</div></div></div>
</article>

        </div>
    </body>
</html>
