<!DOCTYPE html> <html lang="cs" dir="ltr" itemtype="http://schema.org/WebPage" itemscope=""> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Alarmy v Androidu | fragaria.cz</title> <meta name="author" content="Fragaria s.r.o." /> <meta name="robots" content="index,follow" /> <meta name="description" content="Účelem toho příspěvku není vytvořit návod jak si na vašem telefonu sesystémem Android nastavit budík na šestou ráno, ale nahlédnou trochu podpokličku mechanizmu, který se postará o spuštění libovolné akce někdy vbudoucnosti. A jak už to tak na Androidu bývá, nejedná se o mechanizmusjeden, ale hnedněkolik."> <meta name="keywords" content="fragaria, software, vývoj software, webové aplikace, python, javascript, angular, elasticsearch, html, css, alarm, android, scheduler" /> <!-- Favicons --> <link rel="apple-touch-icon" sizes="180x180" href="/website/assets/favicons/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/website/assets/favicons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/website/assets/favicons/favicon-16x16.png"> <link rel="manifest" href="/website/assets/favicons/site.webmanifest"> <link rel="mask-icon" href="/website/assets/favicons/safari-pinned-tab.svg" color="#ea272e"> <link rel="shortcut icon" href="/website/favicon.ico"> <meta name="msapplication-TileColor" content="#ea272e"> <meta name="msapplication-config" content="/website/assets/favicons/browserconfig.xml"> <meta name="theme-color" content="#ea272e"> <meta property="og:url" content="https://fragaria.github.com/website/blog/2016/12/09/alarmy-v-androidu/" /> <meta property="og:type" content="website" /> <meta property="og:title" content="Alarmy v Androidu | fragaria.cz" /> <meta property="og:description" content="Účelem toho příspěvku není vytvořit návod jak si na vašem telefonu sesystémem Android nastavit budík na šestou ráno, ale nahlédnou trochu podpokličku mechanizmu, který se postará o spuštění libovolné akce někdy vbudoucnosti. A jak už to tak na Androidu bývá, nejedná se o mechanizmusjeden, ale hnedněkolik." /> <meta property="og:image" content="https://res.cloudinary.com/fragaria/image/upload/w_640,c_fit,f_jpg,q_auto/fragaria.cz/posts/2016-12-09-alarmy-v-androidu__1.jpg" /> <!-- preload soon-to-be-loaded assets soon in the page lifecycle --> <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin> <!-- preload Google Webfonts stylesheet --> <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700|PT+Serif:400,700&amp;subset=latin-ext" as="style"> <!-- preload OpenSansCondensed-Light latin, 300 --> <link rel="preload" href="https://fonts.gstatic.com/s/opensanscondensed/v12/z7NFdQDnbTkabZAIOl9il_O6KJj73e7Ff1GhDuXMR7eS2Ao.woff2" as="font" type="font/woff2" crossorigin> <!-- preload OpenSansCondensed-Light latin-ext, 300 --> <link rel="preload" href="https://fonts.gstatic.com/s/opensanscondensed/v12/z7NFdQDnbTkabZAIOl9il_O6KJj73e7Ff1GhDuvMR7eS2AopSg.woff2" as="font" type="font/woff2" crossorigin> <!-- preload OpenSansCondensed-Light latin, 700 --> <link rel="preload" href="https://fonts.gstatic.com/s/opensanscondensed/v12/z7NFdQDnbTkabZAIOl9il_O6KJj73e7Ff0GmDuXMR7eS2Ao.woff2" as="font" type="font/woff2" crossorigin> <!-- preload OpenSansCondensed-Light latin-ext, 700 --> <link rel="preload" href="https://fonts.gstatic.com/s/opensanscondensed/v12/z7NFdQDnbTkabZAIOl9il_O6KJj73e7Ff0GmDuvMR7eS2AopSg.woff2" as="font" type="font/woff2" crossorigin> <link rel="preload" href="/website/assets/fonts/fragariacz-icons.ttf?p82sos" as="font" type="font/ttf" crossorigin="anonymous"> <link rel="preload" href="/website/assets/js/site.js?561365b0deb0f2e782e593a570d15df8" as="script"> <link rel="stylesheet" href="/website/assets/styles.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="alternate" type="application/atom+xml" href="/website/feed.xml" title="Atom feed for this page"/> <link rel="self" type="application/atom+xml" href="/website/feed.xml"/> <!-- register service worker --> <script type="text/javascript" src="/website/assets/js/register-sw.js"></script> </head> <!--[if lte IE 10]> <body class="page-container baseline-grid js-baseline-grid old-ie"> <![endif]--> <!--[if gt IE 10]>--> <body class="page-container baseline-grid js-baseline-grid"> <!--<![endif]--> <div class="old-ie-warning"> <img alt="Fragaria s.r.o." src="/website/assets/img/strawberry.svg"> <h1>Fragaria.cz</h1> <p>We are an <b>agile-thinking</b> company. Following the philosophy, we've decided not to support <b>Internet Explorer prior to version 11</b>. It's just not worth the effort.</p> <p>To see our website in it's full glance, we suggest using <a href="https://www.microsoft.com/en-us/windows/microsoft-edge">Microsoft Edge</a>, <a href="https://www.google.com/chrome/">Google Chrome</a>, <a href="https://www.opera.com/download">Opera</a> or <a href="https://www.mozilla.org/en-US/firefox/new/">Mozilla Firefox</a>.</p> <p>Thanks for your understanding.</p> </div> <div class="page-container__inner"> <div class="content-block js-sitenav sitenav-wrapper"> <nav class="sitenav content-block__cover--mobile" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement"> <a href="/website/"> <img alt="Fragaria s.r.o." class="sitenav__brand" src="/website/assets/img/strawberry.svg"> </a> <ul class="sitenav__linkset"> <li class="sitenav__linkset-item sitenav__linkset-item--main"><a href="/website/" class="sitenav__link typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Fragaria.cz</span></a></li> <li class="sitenav__linkset-item js-sitenav-link"><a href="/website/#works" class="sitenav__link typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Works</span></a></li> <li class="sitenav__linkset-item js-sitenav-link"><a href="/website/#team" class="sitenav__link typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Team</span></a></li> <li class="sitenav__linkset-item sitenav__linkset-item--active js-sitenav-link"><a href="/website/blog/" class="sitenav__link typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Blog</span></a></li> <li class="sitenav__linkset-item js-sitenav-link"><a href="/website/career/" class="sitenav__link typeset__anchor--nounderline" itemprop="url"><span itemprop="name">Career</span></a></li> </ul> <div class="sitenav__menu-toggle typeset"> <a href="#" class="sitenav__menu-toggle-link js-sitenav-menu-toggle">Menu</a> </div> </nav> </div> <article itemtype="https://schema.org/TechArticle" itemscope class="article" lang="cs"> <div class="content-block typeset"> <h1 itemprop="name" class="article__headline">Alarmy v Androidu</h1> <meta itemprop="headline" content="Alarmy v Androidu"> <div itemprop="publisher" itemtype="http://schema.org/Organization" class="hidden" itemscope> <div itemprop="logo" itemtype="http://schema.org/ImageObject" itemscope=""> <meta itemprop="url" content="https://fragaria.github.com/website/assets/img/strawberry.svg"> </div> <meta itemprop="name" content="Fragaria s.r.o."> </div> <p class="article__meta"> <span itemprop="author" itemtype="http://schema.org/Person" itemscope="" class="article__author"> by <span itemprop="name">Milan Slezák</span> </span> <meta itemprop="datePublished" content="" /> <span class="article__pubdate">09.12.2016</span> <meta itemprop="publisher"></meta> </p> <div class="article__content-wrap"> <div class="article__content"> <p>Účelem toho příspěvku není vytvořit návod jak si na vašem telefonu se systémem Android nastavit budík na šestou ráno, ale nahlédnou trochu pod pokličku mechanizmu, který se postará o spuštění libovolné akce někdy v budoucnosti. A jak už to tak na Androidu bývá, nejedná se o mechanizmus jeden, ale hned několik.</p> <figure class="figure content-block__cover--mobile "> <img src="https://res.cloudinary.com/fragaria/image/upload/w_640,c_limit,f_auto,q_auto,dpr_2.0/fragaria.cz/posts/2016-12-09-alarmy-v-androidu__1.jpg" srcset="https://res.cloudinary.com/fragaria/image/upload/w_480,c_limit,f_auto,q_auto/fragaria.cz/posts/2016-12-09-alarmy-v-androidu__1.jpg 480w, https://res.cloudinary.com/fragaria/image/upload/w_640,c_limit,f_auto,q_auto/fragaria.cz/posts/2016-12-09-alarmy-v-androidu__1.jpg 640w, https://res.cloudinary.com/fragaria/image/upload/w_1280,c_limit,f_auto,q_auto/fragaria.cz/posts/2016-12-09-alarmy-v-androidu__1.jpg 1280w, https://res.cloudinary.com/fragaria/image/upload/w_1920,c_limit,f_auto,q_auto/fragaria.cz/posts/2016-12-09-alarmy-v-androidu__1.jpg 1920w, https://res.cloudinary.com/fragaria/image/upload/w_1120,c_limit,f_auto,q_auto/fragaria.cz/posts/2016-12-09-alarmy-v-androidu__1.jpg 1120w, https://res.cloudinary.com/fragaria/image/upload/w_2240,c_limit,f_auto,q_auto/fragaria.cz/posts/2016-12-09-alarmy-v-androidu__1.jpg 2240w," class="figure__image js-fix-baseline" /> </figure> <h3 id="k-čemu-alarmy">K čemu alarmy?</h3> <p>Potřebujete vyvolat nějakou akci ve vzdálenější budoucnosti jako třeba rozeznít uživatelův budík? Rádi byste pravidelně synchronizovali data mezi apkou a serverem a popřípadě uživatele upozornili notifikací, že se objevily nějaké novinky, které stojí za to si prohlédnut? Něco vám našeptává že držet kvůli tomu při životě celou aplikaci není to pravé? V tom případě je alarm nebo chce-li job, přesně to co potřebujete.</p> <p>Jedná se totiž o způsob, jak systému Android sdělit, že má za uvedený časový interval nastartovat vaší aplikaci a nechat ji provést nějakou akci. Vzbudit jak? No samozřejmě pomocí dobře známého <strong>Intentu</strong> jakožto standardního prostředku meziaplikační komunikace. Zdá se to být jednoduché až primitivní, ale přece jenom za tím nějaké to tajemství je.</p> <h3 id="baterie-především">Baterie především</h3> <p>Ždímat baterii je většinou to poslední co uživatel od aplikace očekává a proto by měla být četnost alarmů co nejmenší. Tedy samozřejmě tak malá, aby vaše aplikace stále dávala smysl.</p> <p>Představte si aplikaci která má za úkol varovat vás například před zvýšenou koncentrací škodlivin a smogu ve vašem okolí. Logické asi bude pravidelně posílat serveru vaší lokaci (pokud se mění) a jako odpověd dostávat informaci zda v ní byly překročeny limity či nikoliv. Je třeba správně vybalancovat nastavenou periodu dotazování na server tak, aby k dotazům nedocházelo příliš často, ale zároveň aby uživatel nestihl strávit odpoledne v Bohumíně aniž by se dozvěděl, že riskuje zdraví.</p> <p>Jako doplněk ke správnému načasováni však existuje ještě jedna technika jak nějaké ty miliampérhodiny ušetřit.</p> <h3 id="nepřesné-alarmy">Nepřesné alarmy</h3> <p>Ano vážně, pokud nebudete trvat na spuštění v přesně definovaný čas, pomůžete tím Androidu ušetřit nemalou část baterie.</p> <p>Android totiž, když zrovna nemá nic na práci, usne. V tomto stavu má nejmenší odběr a baterii tím šetří. Každý alarm ho však vzbudí a donutí provést rozličné rutiny jako například inicializovat spojení do internetu. Vaše aplikace však v systému není sama a takto ho budí aplikací hned několik. Pokud však při nastavování alarmu řeknete, že jej chcete provést například za 10 minut plus mínus jedna minuta, umožníte tím systému seskupit alarmy různých aplikací a provést tak více činností v rámci jednoho probuzení.</p> <p>Tato optimalizace má na životnost baterie nemalý vliv. Navíc dochází k randomizaci jednotlivých volání což jistě ocení i váš server.</p> <h3 id="alarmující-mechanismy">Alarmující mechanismy</h3> <p>Jak již bylo uvedeno na začátku k nastavování alarmů lze využít hned několik mechanismů. Jedná se o:</p> <ul> <li>Alarm Manager </li> <li>Firebase Job Dispatcher </li> <li>Job Scheduler </li> </ul> <h3 id="alarm-manager">Alarm Manager</h3> <p>Jedná se o nejstarší a zároveň nejméně efektivní způsob přístupu k alarmům. Jeho výhodou je, že do standardního Android SDK patří od začátku a není zde problém s kompatibilitou. Nevýhodou je že nepodporuje “Nepřesné alarmy” a je tedy nejméně efektivní metodou. Jeho API je dosti obecné a neposkytuje takový komfort jako následující dva bratříčci.</p> <h3 id="job-scheduler">Job Scheduler</h3> <p>Naproti tomu Job Scheduler je nejmodernější způsob jak tuto problematiku řešit. API je čisté a intuitivní, jeho použití je efektivní. Nevýhodou je, že byl zařazen do standardního SDK až od verze 21+ a není tedy příliš použitelný pro aplikace vyžadující zpětnou kompatibilitu.</p> <h3 id="firebase-job-dispatcher">Firebase Job Dispatcher</h3> <p>Je knihovna jež přináší zpětnou kompatibilitu už od verze 9+. Má velmi podobné API jako výše uvedený Job Scheduler, který také pro verze 21+ interně používá. Pro verze &lt; 21 interně využívá mechanismus GCM (GCM Task service) a vyžaduje tedy závislost na balíku Play Services. Tato závislost může být nevýhodou neboť na některých zařízeních nemusí být k dispozici.</p> <table> <thead> <tr> <th> </th> <th>Kompatibilita</th> <th>Efektivita</th> <th>Play services</th> </tr> </thead> <tbody> <tr> <td>Alarm Manager</td> <td>1+</td> <td>nízká</td> <td>nevyžaduje</td> </tr> <tr> <td>Job Scheduler</td> <td>21+</td> <td>vysoká</td> <td>nevyžaduje</td> </tr> <tr> <td>Firebase Job Dispatcher</td> <td>9+</td> <td>vysoká</td> <td>vyžaduje</td> </tr> </tbody> </table> <h3 id="trocha-praxe">Trocha praxe</h3> <p>Na závěr si ukážeme jak vytvořit jednoduchou službu, která bude pravidelně (co 10 minut) kontrolovat náš server. Zvolenou technologií je <strong>Firebase Job Dispatcher</strong>, jež je dle mého názoru nejrozumějším kompromisem. Pro absolutní kompatibilitu by bylo třeba příklad ještě doplnit o neefektivní mechanizmus založený na Alarm Manageru.</p> <p>Nejprve přidáme gradle závislost:</p> <figure class="highlight"><pre><code class="language-gradle" data-lang="gradle"><span class="n">compile</span> <span class="s1">'com.firebase:firebase-jobdispatcher:0.5.0'</span></code></pre></figure> <p>Vytvoříme vlastní službu:</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">com.firebase.jobdispatcher.JobParameters</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.firebase.jobdispatcher.JobService</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SmogService</span> <span class="kd">extends</span> <span class="n">JobService</span> <span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onStartJob</span><span class="o">(</span><span class="n">JobParameters</span> <span class="n">job</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Provést komunikaci se serverem a např. vyhodit notifikaci</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onStopJob</span><span class="o">(</span><span class="n">JobParameters</span> <span class="n">job</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure> <p>Kterou zaregistrujeme do manifest.xml:</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;service</span>
	<span class="na">android:exported=</span><span class="s">"false"</span>
	<span class="na">android:name=</span><span class="s">".SmogService"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;intent-filter&gt;</span>
		<span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"com.firebase.jobdispatcher.ACTION_EXECUTE"</span><span class="nt">/&gt;</span>"
	<span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/service&gt;</span></code></pre></figure> <p>A nyní už to jen celé spustit:</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Int</span> <span class="n">periodInSec</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span> <span class="c1">// 10 minut perioda</span>
<span class="kt">int</span> <span class="n">windowStart</span> <span class="o">=</span><span class="n">periodInSec</span> <span class="o">-</span> <span class="mi">60</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">windowEnd</span> <span class="o">=</span> <span class="n">periodInSec</span> <span class="o">+</span> <span class="mi">60</span><span class="o">;</span>
<span class="n">Job</span> <span class="n">job</span> <span class="o">=</span> <span class="n">dispatcher</span><span class="o">.</span><span class="na">newJobBuilder</span><span class="o">()</span>
	<span class="o">.</span><span class="na">setTag</span><span class="o">(</span><span class="n">JOB_TAG</span><span class="o">)</span> <span class="c1">// Označení jobu</span>
	<span class="o">.</span><span class="na">setService</span><span class="o">(</span><span class="n">SmogService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// Naše služba</span>
	<span class="o">.</span><span class="na">setRecurring</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="c1">// Opakuj</span>
	<span class="o">.</span><span class="na">setLifetime</span><span class="o">(</span><span class="n">Lifetime</span><span class="o">.</span><span class="na">FOREVER</span><span class="o">)</span> <span class="c1">// Donekonečna, dokud není expicitně zastaveno</span>
	<span class="o">.</span><span class="na">setReplaceCurrent</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="c1">// Přepiš job pokud již existuje</span>
	<span class="o">.</span><span class="na">setConstraints</span><span class="o">(</span><span class="n">Constraint</span><span class="o">.</span><span class="na">ON_ANY_NETWORK</span><span class="o">)</span> <span class="c1">// Je třeba připoení k internetu, jinak se nespustí</span>
	<span class="o">.</span><span class="na">setTrigger</span><span class="o">(</span><span class="n">Trigger</span><span class="o">.</span><span class="na">executionWindow</span><span class="o">(</span><span class="n">windowStart</span><span class="o">,</span> <span class="n">windowEnd</span><span class="o">))</span> <span class="c1">//Kdy se má spuštět</span>
	<span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">dispatcher</span><span class="o">.</span><span class="na">mustSchedule</span><span class="o">(</span><span class="n">myJob</span><span class="o">);</span> <span class="c1">// Konečně spustit</span></code></pre></figure> <p>A pokud bychom to chtěli vypnout:</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">dispatcher</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="n">JOB_TAG</span><span class="o">);</span></code></pre></figure> <h3 id="závěrem">Závěrem</h3> <p>Ok, ale proč tři způsoby ptáte se? Odpověď je jednoduchá, “Protože Android”. Tato evolučně velmi živá platforma skýtá mnoho takovýchto mysteriózních zákoutí.</p> </div> </div> </div> <div class="content-block"> <div class="article__misc"> <div class="article__miscitem"> <div class="taglist" itemscope itemtype="http://schema.org/WebPage"> <a class="taglist__tag anchor anchor--emphasized" href="/website/blog/archive/tag/alarm/" itemprop="relatedLink">alarm, </a> <a class="taglist__tag anchor anchor--emphasized" href="/website/blog/archive/tag/android/" itemprop="relatedLink">android, </a> <a class="taglist__tag anchor anchor--emphasized" href="/website/blog/archive/tag/scheduler/" itemprop="relatedLink">scheduler</a> </div> </div> <div class="article__miscitem"> <div class="sharebox"> <ul class="sharebox__items"> <li class="sharebox__item sharebox__item--twitter"> <a class="sharebox__item-body" href="https://twitter.com/intent/tweet?text=Alarmy v Androidu&url=https://fragaria.github.com/website/blog/2016/12/09/alarmy-v-androidu/&via=&related=" target="_blank" rel="noopener" title="Share on Twitter"><span>Share on Twitter</span></a> </li> <li class="sharebox__item sharebox__item--facebook"> <a class="sharebox__item-body" href="https://facebook.com/sharer.php?u=https://fragaria.github.com/website/blog/2016/12/09/alarmy-v-androidu/" target="_blank" rel="noopener" title="Share on Facebook"><span>Share on Facebook</span></a> </li> <li class="sharebox__item sharebox__item--gplus"> <a class="sharebox__item-body" href="https://plus.google.com/share?url=https://fragaria.github.com/website/blog/2016/12/09/alarmy-v-androidu/" target="_blank" rel="noopener" title="Share on Google+"><span>Share on Google+</span></a> </li> </ul> </div> </div> </div> </div> </article> <footer class="content-block"> <div class="footer"> <div class="footer__meta"> <a href="/website/"> <img alt="Fragaria s.r.o." class="footer__brand" src="/website/assets/img/strawberry.svg"> </a> <div class="footer__copy"> <div class="footer__copy-line footer__copy-line--emphasized">FRAGARIA (C) 2018</div> <div class="footer__copy-line">Talk is cheap, show me the code.</div> </div> </div> <div class="footer__social"> <a href="https://twitter.com/fragariacz" class="icon--twitter footer__social-icon"></a> <a href="https://linkedin.com/company/fragaria-ltd-" class="icon--linkedin footer__social-icon"></a> <a href="https://plus.google.com/+FragariaCz"class="icon--gplus footer__social-icon"></a> <a href="https://github.com/fragaria"class="icon--github footer__social-icon"></a> </div> </div> </footer> </div> <script src="/website/assets/js/site.js?561365b0deb0f2e782e593a570d15df8"></script> </body> </html>
