---
layout: post
title: Alarmy v Androidu
date: '2016-12-09T10:48:00.000+01:00'
author: Milan Slezák
tags:
- alarm
- android
- scheduler
modified_time: '2016-12-09T10:49:12.606+01:00'
thumbnail: https://4.bp.blogspot.com/-vEW67W0Rf4Q/WEp92ed7nDI/AAAAAAAAArk/u2A0ZCXRMDUsHkkxmKkcQc0ai33JqlzRgCLcB/s72-c/numbers-time-watch-white.jpg
blogger_id: tag:blogger.com,1999:blog-5328688426183767847.post-4242630700744006367
blogger_orig_url: http://blog.fragaria.cz/2016/12/alarmy-v-androidu.html
---

Účelem toho příspěvku není vytvořit návod jak si na vašem telefonu se systémem Android nastavit budík na šestou ráno, ale nahlédnou trochu pod pokličku mechanizmu, který se postará o spuštění libovolné akce někdy v budoucnosti. A jak už to tak na Androidu bývá, nejedná se o mechanizmus jeden, ale hned několik.<br /><br /><a name='more'></a><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-vEW67W0Rf4Q/WEp92ed7nDI/AAAAAAAAArk/u2A0ZCXRMDUsHkkxmKkcQc0ai33JqlzRgCLcB/s1600/numbers-time-watch-white.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://4.bp.blogspot.com/-vEW67W0Rf4Q/WEp92ed7nDI/AAAAAAAAArk/u2A0ZCXRMDUsHkkxmKkcQc0ai33JqlzRgCLcB/s320/numbers-time-watch-white.jpg" width="320" height="213" /></a></div><br/><br/><h3>K čemu alarmy?</h3> <div>Potřebujete vyvolat nějakou akci ve vzdálenější budoucnosti jako třeba rozeznít uživatelův budík? Rádi byste pravidelně synchronizovali data mezi apkou a serverem a popřípadě uživatele upozornili notifikací, že se objevily nějaké novinky, které stojí za to si prohlédnut? Něco vám našeptává že držet kvůli tomu při životě celou aplikaci není to pravé? V tom případě je alarm nebo chce-li job, přesně to co potřebujete.<br /><br />Jedná se totiž o způsob, jak systému Android sdělit, že má za uvedený časový interval nastartovat vaší aplikaci a nechat ji provést nějakou akci. Vzbudit jak? No samozřejmě pomocí dobře známého <b>Intentu</b> jakožto standardního prostředku meziaplikační komunikace. Zdá se to být jednoduché až primitivní, ale přece jenom za tím nějaké to tajemství je. <br /><br/><h3>Baterie především</h3><div>Ždímat baterii je většinou to poslední co uživatel od aplikace očekává a proto by měla být četnost alarmů co nejmenší. Tedy samozřejmě tak malá, aby vaše aplikace stále dávala smysl.<br /><br />Představte si aplikaci která má za úkol varovat vás například před zvýšenou koncentrací škodlivin a smogu ve vašem okolí. Logické asi bude pravidelně posílat serveru vaší lokaci (pokud se mění) a jako odpověd dostávat informaci zda v ní byly překročeny limity či nikoliv. Je třeba správně vybalancovat nastavenou periodu dotazování na server tak, aby k dotazům nedocházelo příliš často, ale zároveň aby uživatel nestihl strávit odpoledne v Bohumíně aniž by se dozvěděl, že riskuje zdraví.<br /><br />Jako doplněk ke správnému načasováni však existuje ještě jedna technika jak nějaké ty miliampérhodiny ušetřit.</div><br/><br/><h3>Nepřesné alarmy</h3><div>Ano vážně, pokud nebudete trvat na spuštění v přesně definovaný čas, pomůžete tím Androidu ušetřit nemalou část baterie.<br /><br />Android totiž, když zrovna nemá nic na práci, usne. V tomto stavu má nejmenší odběr a baterii tím šetří. Každý alarm ho však vzbudí a donutí provést rozličné rutiny jako například inicializovat spojení do internetu. Vaše aplikace však v systému není sama a takto ho budí aplikací hned několik. Pokud však při nastavování alarmu řeknete, že jej chcete provést například za 10 minut plus mínus jedna minuta, umožníte tím systému seskupit alarmy různých aplikací a provést tak více činností v rámci jednoho probuzení.<br /><br />Tato optimalizace má na životnost baterie nemalý vliv. Navíc dochází k randomizaci jednotlivých volání což jistě ocení i váš server.</div><br/><br/><h3>Alarmující mechanismy</h3><div>Jak již bylo uvedeno na začátku k nastavování alarmů lze využít hned několik mechanismů. Jedná se o: <br /><ul><li>Alarm Manager&nbsp;</li><li>Firebase Job Dispatcher&nbsp;</li><li>Job Scheduler&nbsp;</li></ul></div><br/><br/><h3>Alarm Manager</h3><div>Jedná se o nejstarší a zároveň nejméně efektivní způsob přístupu k alarmům. Jeho výhodou je, že do standardního Android SDK patří od začátku a není zde problém s kompatibilitou. Nevýhodou je že nepodporuje “Nepřesné alarmy” a je tedy nejméně efektivní metodou. Jeho API je dosti obecné a neposkytuje takový komfort jako následující dva bratříčci.</div><br /><br/><h3>Job Scheduler</h3><div>Naproti tomu Job Scheduler je nejmodernější způsob jak tuto problematiku řešit. API je čisté a intuitivní, jeho použití je efektivní. Nevýhodou je, že byl zařazen do standardního SDK až od verze 21+ a není tedy příliš použitelný pro aplikace vyžadující zpětnou kompatibilitu.</div><br /></br><h3>Firebase Job Dispatcher</h3><div>Je knihovna jež přináší zpětnou kompatibilitu už od verze 9+. Má velmi podobné API jako výše uvedený Job Scheduler, který také pro verze 21+ interně používá. Pro verze &lt; 21 interně využívá mechanismus GCM  (GCM Task service) a vyžaduje tedy závislost na balíku Play Services. Tato závislost může být nevýhodou neboť na některých zařízeních nemusí být k dispozici.<br /></div><br/><br/><table><colgroup><col width="198"></col><col width="152"></col><col width="152"></col><col width="122"></col></colgroup><tr><th>&nbsp;</th><th>Kompatibilita</th><th>Efektivita</th><th>Play services</th></tr><tr><th>Alarm Manager</th><td style="color:green;">1+</td><td style="color:red;">nízká</td><td style="color:green;">nevyžaduje</td></tr><tr><th>Job Scheduler</th><td style="color:red;">21+</td><td style="color:green;">vysoká</td><td style="color:green;">nevyžaduje</td></tr><tr><th>Firebase Job Dispatcher</th><td style="color:green;">9+</td><td style="color:green;">vysoká</td><td style="color:red;">vyžaduje</td></tr></table><br/><br/><h3>Trocha praxe</h3>Na závěr si ukážeme jak vytvořit jednoduchou službu, která bude pravidelně (co 10 minut) kontrolovat náš server. Zvolenou technologií je <b>Firebase Job Dispatcher</b>, jež je dle mého názoru nejrozumějším kompromisem. Pro absolutní kompatibilitu by bylo třeba příklad ještě doplnit o neefektivní mechanizmus založený na Alarm Manageru.</div><div><br /></div><div>Nejprve přidáme gradle závislost:<br /><br /><script src="https://gist.github.com/krtek/b280f7b6a110df8dc8fe17967e9a90c5.js?file=gradle.groovy"></script> <div><br /></div>Vytvoříme vlastní službu:<br /><br /><script src="https://gist.github.com/krtek/b280f7b6a110df8dc8fe17967e9a90c5.js?file=SmogService.java"></script> Kterou zaregistrujeme do manifest.xml:<br /><br/><script src="https://gist.github.com/krtek/b280f7b6a110df8dc8fe17967e9a90c5.js?file=manifest.xml"></script> A nyní už to jen celé spustit:<br /><br/><script src="https://gist.github.com/krtek/b280f7b6a110df8dc8fe17967e9a90c5.js?file=Main.java"></script>A pokud bychom to chtěli vypnout:<br /><br/><script src="https://gist.github.com/krtek/b280f7b6a110df8dc8fe17967e9a90c5.js?file=Cancel.java"></script><br/><br/><h3>Závěrem</h3><div>Ok, ale proč tři způsoby ptáte se? Odpověď je jednoduchá, “Protože Android”. Tato evolučně velmi živá platforma skýtá mnoho takovýchto mysteriózních zákoutí.</div>