---
layout: post
title: Soumrak promises v Javascriptu aneb Pondělní střípky z 2.5.2016
date: '2016-05-03T09:13:00.000+02:00'
author: Lukáš Marek
tags:
- stripky
- async
- nodejs
- promises
modified_time: '2016-05-03T09:23:24.425+02:00'
thumbnail: https://4.bp.blogspot.com/-8plEfspkc7Q/VyhRs8Kci2I/AAAAAAAAAn4/bsY3ynVYj18C4-tdg5B6pLvYOmKqdXDkwCLcB/s72-c/236H.jpg
blogger_id: tag:blogger.com,1999:blog-5328688426183767847.post-3691982208680064191
blogger_orig_url: http://blog.fragaria.cz/2016/05/soumrak-promises-v-javascriptu-aneb.html
---

Dnes si Hynek uzurpoval skoro dvacet minut, aby nám demonstroval jak nahradit promises <i>reaktivním programováním</i> v NodeJS.<br /><a name='more'></a>I Filip, který jinak rýpe do všeho, sledoval výklad téměř bez dechu. Zkusím&nbsp; tedy Hynkovu přednášku převyprávět i vám.<br /><br /><br /><br />Callback metody, které komplikovaly Javascriptový kód už jsou dávno za zenitem. Najdete je možná v JQuery, ale NodeJS i AngularJS už dávno pro asynchronní volání používají <a href="https://en.wikipedia.org/wiki/Futures_and_promises" target="_blank">promises</a>. Pokud nevíte, na co promises jsou, tak vítám do 21. století a doporučuju třeba <a href="http://www.html5rocks.com/en/tutorials/es6/promises/" target="_blank">tenhle článek</a>.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://4.bp.blogspot.com/-8plEfspkc7Q/VyhRs8Kci2I/AAAAAAAAAn4/bsY3ynVYj18C4-tdg5B6pLvYOmKqdXDkwCLcB/s1600/236H.jpg" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="266" src="https://4.bp.blogspot.com/-8plEfspkc7Q/VyhRs8Kci2I/AAAAAAAAAn4/bsY3ynVYj18C4-tdg5B6pLvYOmKqdXDkwCLcB/s400/236H.jpg" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">(c) http://www.gratisography.com</td></tr></tbody></table>Anebo možná ne. Vypadá to, že i nad promises se začínají stahovat mračna. Standard ES6 totiž obsahuje tzv. <a href="https://developer.mozilla.org/cs/docs/Web/JavaScript/Guide/Iterators_and_Generators" target="_blank">generátory</a> a klíčové slovo <i>yield</i>, což umožňuje použít <a href="https://en.wikipedia.org/wiki/Reactive_programming" target="_blank">reaktivní programování.</a> Jeho použitím se dají zjednodušit některé use-cases a vyhnout se použití promises.<br /><br />Hynek nám to vysvětlil na příkladu unit testu. Následující kus kódu by mohl být třeba ze systému na prodej bannerové reklamy:<br /><br /><script src="https://gist.github.com/krtek/20ced86512f9322651f07221f7274818.js?file=promises.js"></script> I když je kód super jednoduchý a dobře okomentovaný, stejně je tam těch promises <b>prostě moc</b>. Dá se v tom možná vyznat, ale je to spousta <i>boilerplate</i> kódu a čitelnost trpí.<br /><br />S použitím (zneužitím?) generátorů a <a href="http://bluebirdjs.com/docs/api/promise.coroutine.html" target="_blank">couroutine</a> z knihovny <span id="goog_537025175"></span>Bluebird<span id="goog_537025176"></span> se dostaneme k mnohem čitelnějšímu kódu:<br /><br /><script src="https://gist.github.com/krtek/20ced86512f9322651f07221f7274818.js?file=generators.js"></script> <br />Jak to funguje? Všimněte si, že celý test je napsán jako <a href="https://developer.mozilla.org/cs/docs/Web/JavaScript/Reference/Statements/function*" target="_blank">generátorová funkce</a> (to je to <i>function*</i>). A obalen voláním couroutine (to je to <i>co()</i>).<br /><br />Tady je potřeba malou odbočku – jak fungují generátory? Generátor je ze strany konzumenta klasický iterátor. Na každé volání funkce <i>next()</i> se vrátí jedna hodnota. Ze strany producenta se používá klíčové slovo <i>yield</i>, což je takový malý <i>return</i>. Vrátí další hodnotu v pořadí a "uspí" provádění funkce, dokud není zavolán znovu <i>next()</i>.<br /><br />A právě tohle uspání je tady zneužito. Každé volání <i>next()/yield</i> vrátí jednu promise, na kterou se v obalovací funkci počká a pak se zavolá znovu <i>next()</i>. Zajímavé, co?<br /><br />Samozřejmě, že promises umožňují i jiné hrátky, jako třeba <i>Promises.all()</i>, které generátory nahradit nedokáží. Ale pro popsaný příklad sekvenčního volání jde o elegantní náhradu.<br /><br />Takže promises se zatím o své místo na slunci bát nemusí.<br /><br /><br />