---
layout: post
title: NodeJS - jak si (ne)zauzlovat mozek
date: '2014-04-25T02:35:00.000+02:00'
author: Robin Gottfried
tags: 
modified_time: '2014-04-25T02:35:00.464+02:00'
blogger_id: tag:blogger.com,1999:blog-5328688426183767847.post-4789171413603833120
blogger_orig_url: http://blog.fragaria.cz/2014/04/nodejs-jak-si-nezauzlovat-mozek.html
---

Posledních pár týdnů mám příležitost programovat v NodeJS. Je to pro mě nová, zajímavá zkušenost o kterou bych se rád podělil.<br /><h3>Co NodeJS je?</h3>Moje představa byla, že NodeJS je prostě spouštěč JavaScriptu, který běží bez browseru. Ve skutečnosti je NodeJS celá platforma pro tvorbu serverových aplikací, která využívá super-rychlý javaScript engine z Chrome Browseru (V8). K samotnému enginu přidává NodeJS navíc sadu knihoven pro práci se soubory, sockety, procesy, ale i např. pro dědění objektů.<br /><br />Navíc NodeJS samotný - stejně jako V8 a knihovny kolem - je open source a zdarma i pro komerční použití.<br /><h3>Instalace</h3>NodeJS má kvalitní podporu na široké škále operačních systémů.<br />Na mém Jabkovi stačilo napsat: <code>brew install node</code>.<br />Stejně snadno lze node nainstalovat na Ubuntu, Gentoo, Archlinuxu či např. Windows (úplný seznam podporovaných systémů).<br /><h3>Příprava projektu</h3>Pro správu projektu a jeho knihoven se používá npm (Node Package Manager). <br />Nový projekt založíte pomocí příkazu<br /><code>npm init</code><br />Tím se vytvoří soubor package.json, který bude obsahuje konfiguraci projektu jako<br /><ul><li>nastavení jména a verze (name, version, description)</li><li>specifikace knihoven pro produkci a pro vývoj (dependencies a devDependencies)</li><li>scripty, které projekt obsluhují (main a scripts)</li><li>další ...</li></ul>Následně je třeba doinstalovat knihovny, na kterých projekt závisí. Jako příklad vezmu oblíbenou knihovnu "express" pro rychlý vývoj webových aplikací:<br /><br /><pre><span style="font-family: Courier New, Courier, monospace;"><code>npm install</code> --save express</span></pre><pre><span style="font-family: Courier New, Courier, monospace;"><br /></span></pre>... parametr <code><span style="font-family: Courier New, Courier, monospace;">--save</span></code> zajistí přidání knihovny do závislostí v package.json<br /><code>"dependencies": {   "express": "~3.4.8" },  </code>přípdně instalci testovacího frameworku mocha:<br /><pre><span style="font-family: Courier New, Courier, monospace;"><code>npm install</code> --save-dev mocha</span></pre>... parametr <code><span style="font-family: Courier New, Courier, monospace;">--save-dev</span></code> přidá knihovnu do závislostí pro vývoj<br /><pre><code><span style="font-family: Courier New, Courier, monospace;">"devDependencies": {<br />  "mocha": "~1.17.1"<br />},</span><br /></code></pre>Npm instaluje kinhovny do adresáře node_modules. Tento adresář je dobré nedržet zbytečně v repozitáři porojetu, tedy např. pro git je ještě dobré<br /><pre><code><span style="font-family: Courier New, Courier, monospace;">#&gt; echo "node_modules" &gt;&gt; .gitignore</span><br /></code></pre><pre><code><br /></code></pre><span style="font-family: inherit;">Takto připravený projekt je možné nainstalovat na jakýkoliv stroje s nodem pomocí</span><br /><span style="font-family: 'Courier New', Courier, monospace;">git clone&nbsp;git://some.server/path/to/projekt.git</span><br /><span style="font-family: 'Courier New', Courier, monospace;">cd project</span><span style="font-family: 'Courier New', Courier, monospace;">npm install</span><br /><pre><span style="font-family: inherit;">nebo přímo z git repository pomocí</span><br /><span style="font-family: 'Courier New', Courier, monospace;">npm install git://some.server/path/to/projekt.git</span></pre><h3>Organizace projektu</h3>NodeJS umožňuje organizovat kód do modulů. Modulem je script, který do proměnné <code><span style="font-family: Courier New, Courier, monospace;">module.exports</span></code> nastaví vše, co chce exportovat. Tento modul pak naimportujete pomocí funkce <span style="font-family: Courier New, Courier, monospace;">require("cesta/k/modulu")</span>.<br /><br />Příklad:<br /><pre><code><span style="font-family: Courier New, Courier, monospace;"># ./lib/my-module.js:<br />  module.exports.myMessage = "moje veřejná proměnná";<br /></span></code></pre><pre><code><span style="font-family: Courier New, Courier, monospace;"><br /></span></code></pre><pre><code><span style="font-family: Courier New, Courier, monospace;"># ./main.js</span></code></pre><pre><code><span style="font-family: Courier New, Courier, monospace;">  var myModule = require("./lib/my-module");</span></code></pre><pre><code><span style="font-family: Courier New, Courier, monospace;">  console.log(myModule.myMessage);</span></code></pre><pre><code><span style="font-family: Courier New, Courier, monospace;"><br /></span></code></pre><pre><code><span style="font-family: Courier New, Courier, monospace;">&gt; node main.js<br />&gt; moje veřejná proměnná</span><br /></code></pre><pre><code><br /></code></pre>Jak je vidět z příkladu, lokální moduly (tedy ty, které nejsou instalovány v node_modules) musejí být importovány s absolutní či relativní cestou (tj. /path/to/module.js nebo ./module.js).<br /><br />Možná jste si všilmli i toho, že jsem při importu vynechal příponu souboru „.js”. Pokud do require(…) neuvedete příponu, hledá NodeJS soubor <span style="font-family: Courier New, Courier, monospace;">my-module.js</span>, pokud ji nenajde, hledá soubor <span style="font-family: Courier New, Courier, monospace;">my-module/</span><code><span style="font-family: Courier New, Courier, monospace;">index.js</span></code> a naimportu ten. Po několika dnech jsem začal příponu cíleně vynechávat, protože je tak snadné začít psát modul jako jeden soubor, a ve chvíli, kdy se rozroste, rozdělit jej do submodulů v adresáři, aniž by bylo třeba cokoliv upravovat ve zbytku projektu.<br /><h3>Až to bude ...</h3><div>JavaScript nepoužívá vlákna ale asynchronní zpracování. To znamená, že se můžete spolehnout, že se v jednom procesu vykonají všechny synchronní příkazy v pořadí, jak jsou napsány a žádné jiné vlákno jim do toho nebude šťourat. Na druhou stranu většina IO operací nevrací výsledek ale pouze umožňuje nastavit callback, který se má zavolat „až to bude vyřízeno”.&nbsp;</div><div><br /></div><div>Nevýhodou je, že nepozorný programátor může snadno jedním cyklem úplně zastavit celou aplikaci. Výhodou je, že při vhodném návrhu může např. web aplikace na běžném domácím počítači obsloužit tisíce požadavků za sekundu.</div>